#cloud-config
package_update: true
packages:
- git
- python3
- python3-pip
- openssh-clients
- chrony

write_files:
- path: /root/.ssh/id_rsa
  permissions: '0600'
  owner: root:root
  encoding: b64
  content: ${private_key_pem_b64}

- path: /etc/hosts
  append: true
  content: |
    10.0.0.2   ${hg1}
    10.0.0.3   ${hg2}
    10.0.0.4   ${hg3}
    10.0.0.5   ${hg4}

- path: /etc/ansible/ansible.cfg
  permissions: '0644'
  content: |
    [defaults]
    host_key_checking = False
    inventory = /etc/ansible/hosts
    retry_files_enabled = False
    deprecation_warnings = False
    log_path = /var/log/ansible/ansible.log

- path: /etc/ansible/hosts
  permissions: '0644'
  content: |
    [master]
    master.cdp

    [workers]
    node1.cdp
    node2.cdp
    node3.cdp

    [all:vars]
    ansible_user=opc
    ansible_become=True
    ansible_ssh_private_key_file=/root/.ssh/id_rsa

# NOTE: /root/site.yml, /root/blueprint.json, /root/cluster-template.json, and /root/cluster_deploy.yml
# are uploaded by Terraform provisioners AFTER VM creation. Do NOT embed them here to avoid race conditions.

- path: /root/run-ansible.sh
  permissions: '0755'
  owner: root:root
  content: |
    #!/usr/bin/env bash
    set -Eeuo pipefail
    export PATH=$PATH:/usr/local/bin
    KEY=/root/.ssh/id_rsa
    HOSTS=(node1.cdp node2.cdp node3.cdp)

    echo "[run-ansible] Preparando log do Ansible..."
    mkdir -p /var/log/ansible || true
    chmod 755 /var/log/ansible || true

    # ============================================================================
    # WAIT FOR PROVISIONER FILES
    # ============================================================================
    echo "[run-ansible] Aguardando Terraform provisioners copiarem arquivos necessários..."
    echo "[run-ansible] Arquivos requeridos: site.yml, blueprint.json, cluster-template.json, cluster_deploy.yml"

    REQUIRED_FILES=("/root/site.yml" "/root/blueprint.json" "/root/cluster-template.json" "/root/cluster_deploy.yml")
    MAX_WAIT=600  # 10 minutos máximo
    ELAPSED=0

    while true; do
      ALL_EXIST=true
      for FILE in "$${REQUIRED_FILES[@]}"; do
        if [ ! -f "$FILE" ]; then
          ALL_EXIST=false
          break
        fi
      done
      
      if [ "$ALL_EXIST" = true ]; then
        echo "[run-ansible] ✓ Todos os arquivos detectados!"
        break
      fi
      
      if [ $ELAPSED -ge $MAX_WAIT ]; then
        echo "[run-ansible] ✗ TIMEOUT aguardando arquivos dos provisioners!"
        echo "[run-ansible] Arquivos faltando:"
        for FILE in "$${REQUIRED_FILES[@]}"; do
          if [ ! -f "$FILE" ]; then
            echo "  - $FILE (AUSENTE)"
          fi
        done
        exit 1
      fi
      
      echo "[run-ansible] Aguardando... ($ELAPSED/$MAX_WAIT segundos)"
      sleep 5
      ELAPSED=$((ELAPSED + 5))
    done

    # ============================================================================
    # WAIT FOR WORKER SSH ACCESS
    # ============================================================================
    echo "[run-ansible] Aguardando SSH dos workers..."
    for h in "$${HOSTS[@]}"; do
      echo "[run-ansible] Esperando $h:22 ficar disponível"
      # espera a porta 22 responder por até 15 minutos
      for i in $(seq 1 90); do
        if timeout 3 bash -lc "</dev/tcp/$h/22" 2>/dev/null; then
          break
        fi
        sleep 10
      done
      # testa SSH sem checagem de hostkey
      for i in $(seq 1 30); do
        if ssh -i "$KEY" -o StrictHostKeyChecking=no -o ConnectTimeout=5 opc@"$h" echo ok 2>/dev/null; then
          break
        fi
        sleep 5
      done
    done

    # ============================================================================
    # EXECUTE ANSIBLE PLAYBOOKS
    # ============================================================================
    echo "[run-ansible] Executando playbook de configuração..."
    ANSIBLE_NOCOLOR=1 ansible-playbook /root/site.yml

    echo "[run-ansible] Executando playbook de deploy..."
    ANSIBLE_NOCOLOR=1 ansible-playbook /root/cluster_deploy.yml

runcmd:
- [ sh, -lc, "systemctl enable chronyd && systemctl start chronyd" ]
- [ sh, -lc, "mkdir -p /var/log/ansible && chmod 755 /var/log/ansible" ]
- [ sh, -lc, "python3 -m pip install --upgrade pip ansible" ]
- [ sh, -lc, "/root/run-ansible.sh" ]
