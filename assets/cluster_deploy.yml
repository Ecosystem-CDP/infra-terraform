- name: Deploy Ambari Cluster
  hosts: localhost
  gather_facts: no
  vars:
    ambari_user: admin
    ambari_pass: admin
    ambari_url: http://localhost:8080/api/v1
    blueprint_file: /root/blueprint.json
    vdf_file: /root/ODP-VDF.xml
    cluster_template_file: /root/cluster-template.json
    cluster_name: odp-cluster

  tasks:
  - name: Wait for Ambari Server to be ready
    uri:
      url: "{{ ambari_url }}/check"
      user: "{{ ambari_user }}"
      password: "{{ ambari_pass }}"
      force_basic_auth: yes
      headers:
        X-Requested-By: "ambari"
      return_content: no
    register: ambari_check
    until: ambari_check.status == 200
    retries: 30
    delay: 10
    ignore_errors: yes

  - name: Wait for all 4 hosts to be registered
    uri:
      url: "{{ ambari_url }}/hosts"
      user: "{{ ambari_user }}"
      password: "{{ ambari_pass }}"
      force_basic_auth: yes
      headers:
        X-Requested-By: "ambari"
      return_content: yes
    register: hosts_response
    until: hosts_response.status == 200 and (hosts_response.content | from_json)['items'] | length == 4
    retries: 60
    delay: 10
    ignore_errors: yes

  - name: Delete existing Cluster
    uri:
      url: "{{ ambari_url }}/clusters/{{ cluster_name }}"
      method: DELETE
      user: "{{ ambari_user }}"
      password: "{{ ambari_pass }}"
      force_basic_auth: yes
      headers:
        X-Requested-By: "ambari"
      status_code: [ 200, 202, 404 ]

  - name: Wait for Cluster to be deleted
    uri:
      url: "{{ ambari_url }}/clusters/{{ cluster_name }}"
      method: GET
      user: "{{ ambari_user }}"
      password: "{{ ambari_pass }}"
      force_basic_auth: yes
      headers:
        X-Requested-By: "ambari"
      status_code: [ 404 ]
    register: cluster_gone
    until: cluster_gone.status == 404
    retries: 60
    delay: 5

  - name: Register VDF
    uri:
      url: "{{ ambari_url }}/version_definitions"
      method: POST
      user: "{{ ambari_user }}"
      password: "{{ ambari_pass }}"
      force_basic_auth: yes
      headers:
        X-Requested-By: "ambari"
      body:
        VersionDefinition:
          version_url: "file://{{ vdf_file }}"
      body_format: json
      status_code: [ 201, 409, 500 ]
    register: vdf_registration
    failed_when: vdf_registration.status != 201 and "Duplicate" not in vdf_registration.json.message|default("") and vdf_registration.status != 500

  - name: Delete existing Blueprint
    uri:
      url: "{{ ambari_url }}/blueprints/odp-blueprint"
      method: DELETE
      user: "{{ ambari_user }}"
      password: "{{ ambari_pass }}"
      force_basic_auth: yes
      headers:
        X-Requested-By: "ambari"
      status_code: [ 200, 404 ]

  - name: Register Blueprint
    uri:
      url: "{{ ambari_url }}/blueprints/odp-blueprint?validate_topology=false"
      method: POST
      user: "{{ ambari_user }}"
      password: "{{ ambari_pass }}"
      force_basic_auth: yes
      headers:
        X-Requested-By: "ambari"
      body: "{{ lookup('file', blueprint_file) }}"
      body_format: json
      status_code: [ 201, 409 ]

  - name: Create Cluster
    uri:
      url: "{{ ambari_url }}/clusters/{{ cluster_name }}"
      method: POST
      user: "{{ ambari_user }}"
      password: "{{ ambari_pass }}"
      force_basic_auth: yes
      headers:
        X-Requested-By: "ambari"
      body: "{{ lookup('file', cluster_template_file) }}"
      body_format: json
      status_code: 202
    register: cluster_request

  - name: Monitor Cluster Creation
    uri:
      url: "{{ cluster_request.json.href }}"
      user: "{{ ambari_user }}"
      password: "{{ ambari_pass }}"
      force_basic_auth: yes
      headers:
        X-Requested-By: "ambari"
      return_content: yes
    register: request_status
    until: (request_status.content | from_json).Requests.request_status == 'COMPLETED' or (request_status.content | from_json).Requests.request_status == 'FAILED'
    retries: 360
    delay: 30
    when: cluster_request.status == 202

  - name: Handle Cluster Creation Failure
    block:
    - name: Fail if status is failed (to trigger rescue)
      fail:
        msg: "Cluster creation failed initially."
      when: cluster_request.status == 202 and (request_status.content | from_json).Requests.request_status == 'FAILED'

    rescue:
    - name: Attempting Auto-Fix for HDFS Upload (OOM workaround)
      shell: sh /root/hdfscorrections.sh
      delegate_to: master.cdp

    - name: Retry Failed Cluster Creation Request
      uri:
        url: "{{ ambari_url }}/clusters/{{ cluster_name }}/requests/{{ (request_status.content | from_json).Requests.id }}?retry_host_names=master.cdp"
        method: POST
        user: "{{ ambari_user }}"
        password: "{{ ambari_pass }}"
        force_basic_auth: yes
        headers:
          X-Requested-By: "ambari"
        body: "{}"
        body_format: json
        status_code: 202
      register: retry_request

    - name: Monitor Retry Request
      uri:
        url: "{{ retry_request.json.href }}"
        user: "{{ ambari_user }}"
        password: "{{ ambari_pass }}"
        force_basic_auth: yes
        headers:
          X-Requested-By: "ambari"
        return_content: yes
      register: retry_status
      until: (retry_status.content | from_json).Requests.request_status == 'COMPLETED' or (retry_status.content | from_json).Requests.request_status == 'FAILED'
      retries: 360
      delay: 10

    - name: Fail if retry failed
      fail:
        msg: "Cluster creation failed even after retry. Check Ambari logs."
      when: (retry_status.content | from_json).Requests.request_status == 'FAILED'
